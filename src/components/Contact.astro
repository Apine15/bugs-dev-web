---
// src/components/Contact.astro
---

<section id="contacto" class="py-20 px-6 md:px-12 bg-brand-bg relative">
  <div class="max-w-4xl mx-auto text-center">
    
    <h2 class="text-3xl md:text-5xl font-bold mb-8">
      ¬øTienes una idea? <span class="text-brand-crimson">Hablemos</span>
    </h2>
    
    <p class="text-xl opacity-80 mb-12 max-w-2xl mx-auto">
      Cu√©ntanos sobre tu proyecto. Si buscas un equipo que entienda de c√≥digo y de negocios, somos nosotros.
    </p>

    <form 
      id="contact-form"
      action="https://formspree.io/f/mbddyzed" 
      method="POST"
      class="bg-black/40 border border-white/10 p-8 md:p-12 rounded-2xl shadow-2xl max-w-2xl mx-auto text-left space-y-6"
    >
      
      <div>
        <label for="name" class="block text-sm font-medium mb-2 opacity-80">Tu Nombre</label>
        <input type="text" name="name" id="name" required class="w-full bg-white/15 border border-white/10 rounded-lg px-4 py-3 focus:outline-none focus:border-brand-lime focus:ring-1 focus:ring-brand-lime transition-colors" placeholder="Ej: Ana Garc√≠a" />
      </div>

      <div>
        <label for="email" class="block text-sm font-medium mb-2 opacity-80">Tu Email</label>
        <input type="email" name="email" id="email" required class="w-full bg-white/15 border border-white/10 rounded-lg px-4 py-3 focus:outline-none focus:border-brand-lime focus:ring-1 focus:ring-brand-lime transition-colors" placeholder="ana@empresa.com" />
      </div>

      <div>
        <label for="message" class="block text-sm font-medium mb-2 opacity-80">Cu√©ntanos tu idea</label>
        <textarea name="message" id="message" rows="4" required class="w-full bg-white/15 border border-white/10 rounded-lg px-4 py-3 focus:outline-none focus:border-brand-lime focus:ring-1 focus:ring-brand-lime transition-colors" placeholder="Necesito una web para..."></textarea>
      </div>

      <button id="submit-btn" type="submit" class="w-full bg-brand-crimson text-white font-bold py-4 rounded-lg hover:brightness-110 transition shadow-lg shadow-brand-crimson/20 flex justify-center items-center gap-2">
        <span>Enviar Mensaje üöÄ</span>
      </button>

    </form>

  </div>

  <div id="toast" class="fixed bottom-5 right-5 z-50 transform translate-y-20 opacity-0 transition-all duration-500 ease-in-out pointer-events-none">
    <div id="toast-content" class="px-6 py-4 rounded-lg shadow-2xl border border-white/10 flex items-center gap-3 font-medium">
        </div>
  </div>

</section>

<script>
  // 1. Aserciones: Le decimos a TS qu√© tipo de elemento HTML es cada uno
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const button = document.getElementById('submit-btn') as HTMLButtonElement;
  const toast = document.getElementById('toast');
  const toastContent = document.getElementById('toast-content');

  // 2. Tipado de par√°metros: (message: string, type: string)
  const showToast = (message: string, type: string) => {
    if(!toast || !toastContent) return;

    if (type === 'success') {
      toastContent.className = "px-6 py-4 rounded-lg shadow-2xl border border-brand-lime/50 bg-brand-bg text-brand-lime flex items-center gap-3 font-medium";
      toastContent.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> ${message}`;
    } else {
      toastContent.className = "px-6 py-4 rounded-lg shadow-2xl border border-brand-crimson/50 bg-brand-bg text-brand-crimson flex items-center gap-3 font-medium";
      toastContent.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> ${message}`;
    }

    toast.classList.remove('translate-y-20', 'opacity-0');
    
    setTimeout(() => {
      toast.classList.add('translate-y-20', 'opacity-0');
    }, 4000);
  };

  // 3. Null Check: Solo ejecutamos si el form y el bot√≥n existen
  if (form && button) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const originalBtnText = button.innerHTML;
      button.innerHTML = "<span>Enviando... ‚è≥</span>";
      button.disabled = true; // Usamos la propiedad nativa disabled
      button.classList.add('opacity-70', 'cursor-not-allowed');

      const formData = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: form.method,
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          form.reset();
          showToast("¬°Mensaje recibido! Te contactaremos pronto.", "success");
        } else {
            const data = await response.json();
            if (data.errors) {
                // Mapeamos los errores a un solo string
                const errorMsg = data.errors.map((err: any) => err.message).join(", ");
                showToast(errorMsg, "error");
            } else {
                showToast("Hubo un error al enviar. Intenta de nuevo.", "error");
            }
        }
      } catch (error: any) { // Tipamos el error como 'any' para poder leerlo si hace falta
        showToast("Error de conexi√≥n. Revisa tu internet.", "error");
      } finally {
        button.innerHTML = originalBtnText;
        button.disabled = false;
        button.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    });
  }
</script>